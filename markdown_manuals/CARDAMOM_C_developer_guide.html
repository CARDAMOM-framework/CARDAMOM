

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CARDAMOM C developer guide &mdash; CARDAMOM  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=3ce236e8" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="CARDAMOM Netcdf input file" href="CARDAMOM_NETCDF_INPUT_FILE.html" />
    <link rel="prev" title="Diagnose and resolve memory leaks" href="C_MEMORY_LEAKS.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CARDAMOM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">CARDAMOM Overview:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cardamom_overview/overview.html">CARDAMOM overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cardamom_overview/forward_model.html">Forward model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cardamom_overview/model_data_fusion.html">Model-data fusion</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DALEC Model:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dalec_versions.html">DALEC versions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model-data fusion framework:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../framework/cost_function.html">Cost function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../framework/observation_operators.html">Observation operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../framework/mcmc.html">MCMC</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using CARDAMOM:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../using_cardamom/file_io.html">File formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_cardamom/compilation.html">Compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_cardamom/analyst_checklist.html">Analyst checklist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_cardamom/technote.html">Contributing to this technical documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_cardamom/governance.html">CARDAMOM.c governance structure</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Old Markdown Manual:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ADDING_NEW_NETCF_VARIABLES_AND_ATTRIBUTES.html">Adding new netcdf variables and attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="C_MEMORY_LEAKS.html">Diagnose and resolve memory leaks</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">CARDAMOM C developer guide <a name="cardamom-c-developer-guid"/></a><ul>
<li class="toctree-l2"><a class="reference internal" href="#intro-tips">Intro tips.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#make-a-new-model">Make a new model.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-more-parameters-to-the-model">Add more parameters to the model.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-more-pools-to-the-model">Add more pools to the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#guidelines-on-comments-and-naming-conventions">Guidelines on comments and naming conventions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#two-examples-make-it-easier-to-understand">Two examples make it easier to understand:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-a-new-dataset-to-cardamom-data-structure">Add a new dataset to CARDAMOM DATA structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-a-new-cost-function-soon-to-be-obsolete">Make a new cost function (soon to be obsolete)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="CARDAMOM_NETCDF_INPUT_FILE.html">CARDAMOM Netcdf input file</a></li>
<li class="toctree-l1"><a class="reference internal" href="COST_FUNCTION.html">CARDAMOM cost function <a name="cardamom-cost-function"/></a></li>
<li class="toctree-l1"><a class="reference internal" href="DEBUGGING_TIPS.html">Debugging tips and FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="GETTING_STARTED.html">Getting Started with CARDAMOM <a name="-getting-started"/></a></li>
<li class="toctree-l1"><a class="reference internal" href="GITHUB_BASICS.html">Using CARDAMOM’s github repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="MATLAB_DEMO.html">MATLAB demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="MCMC_IN_CARDAMOM_OVERVIEW.html">MCMC overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="MODEL_IDs.html">DALEC model IDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="OUTPUT_DATA_ANALYSIS.html">Output Data and Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="PARALLELIZATION.html">Parallelization</a></li>
<li class="toctree-l1"><a class="reference internal" href="PERTURBATION_EXPERIMENTS.html">Perturbation experiments using CARDAMOM outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="PYTHON_DEMO.html">Python demo</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">Copyright</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CARDAMOM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">CARDAMOM C developer guide <a name="cardamom-c-developer-guid"/></li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/markdown_manuals/CARDAMOM_C_developer_guide.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="cardamom-c-developer-guide">
<h1>CARDAMOM C developer guide <a name="cardamom-c-developer-guid"/><a class="headerlink" href="#cardamom-c-developer-guide" title="Link to this heading"></a></h1>
<section id="intro-tips">
<h2>Intro tips.<a class="headerlink" href="#intro-tips" title="Link to this heading"></a></h2>
<p>Before doing any of the following, start a new branch and used it as your developing branch to avoid potential conflicts. Constantly pull from the main branch (or any branch that your branch is based on) to keep your branch updated.<br />
Regularly &amp; frequently compile (e.g. CARDAMOM_COMPILE) when making any changes.<br />
If you’re comfortable with your changes and want to contribute your changes to the main branch (or any branch that you want to merge to), start a merge request and notify members of the team.</p>
</section>
<section id="make-a-new-model">
<h2>Make a new model.<a class="headerlink" href="#make-a-new-model" title="Link to this heading"></a></h2>
<p>Making a new model ID in CARDAMOM (e.g. ID=830), based on original model (e.g. ID=811). To do this:</p>
<ol class="arabic simple">
<li><p>Open C/projects/CARDAMOM_GENERAL/CARDAMOM_MODEL_LIBRARY.c and create new model identification information (e.g. ID = 830).</p></li>
<li><p>make folder in projects/CARDAMOM_MODELS/DALEC/DALEC_830 (if copied, open all files in folder and rename all instances of e.g. ”811” to “830”).</p></li>
</ol>
<p>Tips for step 2.</p>
<ul class="simple">
<li><p>copy every instance of DALEC_811 and name them DALEC_830.</p></li>
<li><p>Compile C code to check if it compiles.</p></li>
</ul>
<ul class="simple">
<li><p>(Matlab) You can use “CARDAMOM_COMPILE” in matlab, to see if the code compiles OK.</p></li>
</ul>
<ul class="simple">
<li><p><em>if the above works without issue, then you should be able to change a CBF.ID value to CBF.ID=830 and the model will run (e.g. with CARDAMOM_RUN_MODEL) without issue!</em></p></li>
<li><p>Once you’ve successfully replicated CBF.ID=811 to CBF.ID=830, you can then make model structure changes in DALEC_830.c</p></li>
<li><p>Keep using “CARDAMOM_COMPILE” every so often (in matlab, and equivalent function elsewhere) to see if your new code compiles OK.</p></li>
</ul>
<p><em>For matlab users</em></p>
<ul class="simple">
<li><p>Open CARDAMOM_RUN_MODEL.m and add the new model ID to the appropriate “if” statement (e.g. if CBF.ID==1000 || CBF.ID==1001;).</p></li>
</ul>
<p>(shall this be deleted? since for matlab users we are only extracting CBR.PARS, CBR.FLUXES and CBR.POOLS)
From CARDAMOM_RUN_MODEL.m we get a CBR structure, we are only extracting CBR.PARS, CBR.FLUXES and CBR.POOLS for subsequent analysis. There’s an updated, easy way to figure out output variable names, for your model ID:</p>
<p>eg. if your model ID is 1100</p>
<p>MD=CARDAMOM_MODEL_LIBRARY(1100,[],1);</p>
<p>MD extracts parameters, fluxes, and pools names in the same order they were defined in your DALEC model source code. To calculate subsequent fluxes of interest, eg., NBE:</p>
<p>mod.NBE = -CBR.FLUXES(:,:,MD.FLUX_IDs.gpp)+CBR.FLUXES(:,:,MD.FLUX_IDs.resp_auto)+CBR.FLUXES(:,:,MD.FLUX_IDs.rh_co2);</p>
<p>MD.FLUX_IDs.gpp points to a numeric number that points to the exact dimension in the CBR.FLUXES, which is the modeled gpp.</p>
</section>
<section id="add-more-parameters-to-the-model">
<h2>Add more parameters to the model.<a class="headerlink" href="#add-more-parameters-to-the-model" title="Link to this heading"></a></h2>
<p>update this section with instructions for parameter index abstraction</p>
<ol class="arabic simple">
<li><p>In the folder titled C/projects/CARDAMOM_MODELS/DALEC/DALEC_<newmodelid>, open MODEL_INFO_<newmodelid>.c, and change “DALECmodel.nopars” (e.g. from “33” to “35”)</p></li>
<li><p>Open PARS_INFO_<newmodelid>.c and add two extra entries at the bottom of the code (with minimum and maximum values). Note: CARDAMOM only supports positive-definite values, if a -ve to +ve range is required, use “exp()” function for -ve to +ve value ranges, and use “log()” to transform these back within DALEC_<newmodelid>.c model.</p></li>
<li><p><em>For matlab users</em>. Run this line in the matlab command window after making any changes to the number of parameters or pools in MODEL_INFO_<newmodelid>.c</p></li>
</ol>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">MD</span><span class="p">=</span><span class="n">CARDAMOM_MODEL_LIBRARY</span><span class="p">(</span><span class="o">&lt;</span><span class="n">newmodelid</span><span class="o">&gt;</span><span class="p">,[],</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>(where <newmodelid> is the ID for your new model). This will ensure new model parameter/pool info is registered in matlab. This function can be used later in your analysis, see examples in the sections ‘make a new model’.</p>
</section>
<section id="add-more-pools-to-the-model">
<h2>Add more pools to the model<a class="headerlink" href="#add-more-pools-to-the-model" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p>In the folder titled C/projects/CARDAMOM_MODELS/DALEC/DALEC_<newmodelid>, open MODEL_INFO_<newmodelid>.c, and change “DALECmodel.nopools” (e.g. from “8” to “9”)</p></li>
<li><p>To optimize the pool initial conditions along with other parameters, add an extra parameter to the model. Follow instructions in “Add more parameters to the model” section to do this.</p></li>
<li><p><em>FOR MATLAB USERS</em>. Run this line in the matlab command window after making any changes to the number of parameters or pools in MODEL_INFO_<newmodelid>.c:</p></li>
</ol>
<p>“MD=CARDAMOM_MODEL_LIBRARY(<newmodelid>,[],1);”</p>
<p>(where <newmodelid> is the ID for your new model). This will ensure new model parameter/pool info is registered in matlab.</p>
<ol class="arabic simple" start="4">
<li><p>Adapt EDC2_<newmodelid>.c to either</p>
<ul class="simple">
<li><p>(a) run EDC checks on new pools or</p></li>
<li><p>(b) limit EDC checks to previously existing pools only (check for instances where “nopools” variable is used in loops). This is (unfortunately) a less-than-elegant approach, and we’re working on a comprehensive solution in the long run.</p></li>
<li><p>Define prior range for parameters and why log transformed prior range is used</p></li>
<li><p>Avoid using zero as either the minimum or maximum parameter values, as log transformation is used for creating the new parameter values so that there is equal chance being selected within the same magnitude. Log transformation is essential for parameters spanning several magnitudes, like Soil Organic Carbon turnover rate, while doesn’t make a big difference for parameters like Q10;</p></li>
</ul>
</li>
</ol>
</section>
<section id="guidelines-on-comments-and-naming-conventions">
<h2>Guidelines on comments and naming conventions<a class="headerlink" href="#guidelines-on-comments-and-naming-conventions" title="Link to this heading"></a></h2>
<p>I think we would do well to have a lot more comments in our code describing what the variables are. Maybe some “rule of thumb” that every new variable definition requires a comment that explains exactly what it is?</p>
<p>Of course, if those comments are incorrect, then they will be more hurtful than helpful, so it is important that any subsequent changes to the code are accounted for in the comments. For example, at one point, AUTO_RESP_MAINTENANCE did contain the total maintenance respiration flux from all pools, and then subsequently changed to exclude foliar. So if we had defined AUTO_RESP_MAINTENANCE with a comment, that comment would have needed to be updated. Forgetting to update the comment would then leave us more vulnerable than we’d have been with no comment to begin with.</p>
<p>I suppose another thing that would help is to be careful with variable names, especially when we change a variable as we did with AUTO_RESP_MAINTENANCE. Maybe another rule of thumb would be that we MUST rename a variable when redefining what it means? That way, some other person who may be unaware of the change won’t falsely think they know what a variable is based on knowing it’s previous definition.</p>
<section id="two-examples-make-it-easier-to-understand">
<h3>Two examples make it easier to understand:<a class="headerlink" href="#two-examples-make-it-easier-to-understand" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Soil organic C turnover rate (1e-7 to 1e-3 gC yr-1)</p></li>
<li><p>Temperature sensitivity (Q10, 1.2 to 1.6)</p></li>
<li><p>For soil organic c turnover rate, we want equal possibilities for values spanning 1e-7 to 1e-6, 1e-6 to 1e-5,1e-5 to 1e-4, and 1e-4 to 1e-3, instead of equal chances for values spanning 10e-7 to 0.1<em>1e-3, 0.1</em>1e-3 to 0.2<em>1e-3, 0.2</em>1e-3 to 0.3<em>1e-3, … 0.9</em>1e-3 to 1* 1e-3.</p></li>
</ul>
<p>Left figures are showing the uniform space distributions; Middle figures are showing the log uniform space distributions, which is used in CARDAMOM MCMC; Right figures are showing the actual uniform space distributions in order to get the middle distribution;</p>
<p><img alt="image1" src="../_images/image1_manual.png" /></p>
</section>
<section id="add-a-new-dataset-to-cardamom-data-structure">
<h3>Add a new dataset to CARDAMOM DATA structure<a class="headerlink" href="#add-a-new-dataset-to-cardamom-data-structure" title="Link to this heading"></a></h3>
<p>Example: NBE uncertainty, CH4, etc.</p>
<p>Files that are Modified:</p>
<ul class="simple">
<li><p>CARDAMOM read/writer Matlab/ Python (e.g. add to list of obsnames in “CBFOBS=compile_cbf_obs_fields(CBF)”)</p></li>
<li><p>CARDAMOM_WRITE_BINARY_FILEFORMAT.m; CARDAMOM_READ_BINARY_FILEFORMAT.m</p></li>
<li><p>CARDAMOM_DATA_STRUCTURE.c</p></li>
<li><p>CARDAMOM_READ_BINARY_DATA.c</p></li>
</ul>
<ol class="arabic simple" start="0">
<li><p>To add changes, can simply search for term ‘CH4’ to find all the spots you need to add your new term</p></li>
<li><p>Add observation variable name to CARDAMOM_DATA_STRUCTURE.c (e.g. follow “GPP” entry as example)</p>
<ul class="simple">
<li><p>Add number of indices and number of none zero obs (again, follow GPP example throughout code)</p></li>
</ul>
</li>
<li><p>Add to CARDAMOM_READ_BINARY_DATA.c</p>
<ul class="simple">
<li><p>Initialize data structure, top of file</p></li>
<li><p>~L:150; initialize field: e.g. if (DATA-&gt;NEEunc==0){DATA-&gt;NEEunc=calloc(DATA-&gt;nodays,sizeof(double));}</p></li>
<li><p>~L:210; add line by line reading of observations</p></li>
<li><p>Located in the binary file by the order of observations</p></li>
<li><p>~L:266; if (DATA-&gt;noobs&gt;11){c=0;for (n=0;n<DATA->nodays;n++){if (DATA-&gt;NEEunc[n]&gt;-9998){DATA-&gt;neeuncpts[c]=n;c=c+1;}}}</p></li>
<li><p>Free the point of the structure ~L:350</p></li>
<li><p>~L:360, free the structure (avoid segmentation fault)</p></li>
</ul>
</li>
<li><p>Add to CARDAMOM_WRITE_BINARY_FILEFORMAT.m</p></li>
<li><p>Data is available in the data structure for use in Likelihood etc.</p>
<ul class="simple">
<li><p>Optional: add new cost function module (e.g. DATA_LIKELIHOOD_CH4.c) to use</p></li>
<li><p>To do this, add cost function module call in CARDAMOM/C/projects/DALEC_CODE/MODEL_LIKELIHOOD_FUNCTIONS/DALEC_ALL_LIKELIHOOD.c</p></li>
<li><p>If observation field can only be used by subset of models (e.g. DATA.CH4 can only be used by DATA.ID==1010), then add “IF” statement to only run “DATA_LIKELIHOOD_CH4.c” if DATA.ID==1010.</p></li>
</ul>
</li>
<li><p>Refer to section ‘Make a new cost function’ to add your new stream to cost function</p></li>
</ol>
</section>
<section id="make-a-new-cost-function-soon-to-be-obsolete">
<h3>Make a new cost function (soon to be obsolete)<a class="headerlink" href="#make-a-new-cost-function-soon-to-be-obsolete" title="Link to this heading"></a></h3>
<p>1: Create or copy existing DALEC like function (e.g. copy GPP_LIKELIHOOD.c)
* E.g. cp DALEC_LIKELIHOOD_GPP.c DALEC_LIKELIHOOD_NEE.c</p>
<p>2: Add ~L:10 include new cost function module in the overhead of the master file (DALEC_ALL_LIKELIHOOD.c). A call new module in code
* E.g. #include “DALEC_LIKELIHOOD_NEE.c”
* P=P+DALEC_LIKELIHOOD_NEE(D);</p>
<p>3: Write new cost function (e.g. in DALEC_LIKELIHOOD_NEE.c)
* Switches for EDCs
* Switches CBF.OTHERPRIORS (Anthony provide more detail)</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="C_MEMORY_LEAKS.html" class="btn btn-neutral float-left" title="Diagnose and resolve memory leaks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="CARDAMOM_NETCDF_INPUT_FILE.html" class="btn btn-neutral float-right" title="CARDAMOM Netcdf input file" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../copyright.html">Copyright</a> (c) 2024 California Institute of Technology (“Caltech”) and University of Washington. U.S. Government sponsorship acknowledged..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>